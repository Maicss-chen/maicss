> {
>   "title": "一个类似Windows的安装工具",
>   "datetime": "2022年7月1日 3:42"
> }

# 前因

这两天做了一个Linux下安装游戏的工具，也可以说是一套机制。希望能供给Linux游戏站使用。该站原来大量使用AppImage格式进行分发，这个方案能保证站内游戏可以在大部分发行版下正常运行，但是如果要支持多架构，就需要给每个游戏的每个架构打一个包，这就导致增加服务器负载。但其实大多游戏中，所占体积最大的内容是资源文件，并非二进制，而资源文件大多与架构无关。因此，需要一个安装方式能做到只打包一份资源文件，外加多种架构的二进制，安装程序在安装时自动通过架构选择对应的二进制文件，并同时部署资源文件即可。这样，在分发时就会很大程度上降低服务器空间需求。

# 思路

要实现的目标是用户得到一个安装包，双击安装包或右键运行，弹出安装界面，用户根据引导点击下一步直至安装完成。

目前实现的方案是构建一个自解压的脚本，运行后将准备好的内容解压到临时文件夹，其中包括安装程序和需要安装的游戏内容，运行此安装程序，该程序将游戏内容正确地部署至用户选择的安装位置，并添加快捷方式。

## 自解包机制

为了实现点击运行的效果，需要让安装包能将自己解压出来并运行其中内容，这个机制实现起来非常简单，就是将脚本和压缩包合并成一个文件，就像这样：

```shell
cat unpack.sh res.tar > setup.sh
```

unpack.sh内容如下：

```shell
#!/bin/bash
notify-send "Gameux" "正在解压数据，安装器稍后将自动启动" -t 5000
line=`wc -l $0|awk '{print $1}'`
line=`expr $line - 9` # 9代表脚本的最大行号（行数-1 且不算最后的一个空行）
mkdir /tmp/Gameux
tail -n $line $0 | tar -xC /tmp/Gameux
cd /tmp/Gameux
./installer_x86_64 ./config.json
ret=$?
exit $ret

```

该脚本的大致逻辑是将追加在脚本尾部的压缩包数据，通过标准输入流传递给tar命令，并将该数据流解压到指定位置。

> 注意：脚本中最后一行的空行必须存在，因为脚本是按照行去截取的，压缩包数据必须在一个新的行中，否则将追加到脚本最后一行，导致得到的压缩包数据不完整而无法解压。

这个压缩包内有以下内容：

```
├── config.json
├── data
├── game.desktop
├── game_x86_64
├── installer_x86_64
└── README.txt
```
其中installer_x86_64为Qt开发的图形界面安装器，config.json为其配置文件，其他是游戏内容相关的，这部分下面详细介绍。

## 图形界面安装器

使用Qt开发一个安装器，该安装器要做以下工作：
1. 读取配置文件：从配置文件中读取安装程序信息，其中包括游戏名、版本、资源文件目录、对应架构的二进制目录列表、desktop文件等。
2. 引导用户进行安装设置：用户点击下一步，去选择安装位置、是否在桌面添加快捷方式等。
3. 安装资源文件：将资源文件复制到游戏的安装目录。
4. 安装二进制文件：将对应架构的二进制文件复制到游戏的安装目录。
5. 部署desktop文件：修改desktop文件，并将其放在对应文件夹中。

配置文件如下所示：

```json
{
  "name": "王国保卫战:前线",
  "version": "1.4.4",
  "packageName": "krf",
  "desktopFile": "game.desktop",
  "data": "data",
  "game": [
    {
      "path": "game_x86_64",
      "arch": "x86_64"
    }
  ],
  "readme": "README.txt"
}
```

其中重要的内容是data和game，data表示资源文件目录，game表示二进制文件目录，由于要支持多架构，因此这里是一个列表，需要为每个架构提供目录，若这里不存在某个架构，则表示不支持该架构。安装器最终的行为就是将这两个目录合并后部署到安装位置。

另外就是desktopFile，由于最终安装位置是由用户选择的，因此该文件中需要用到安装目录的字段，需要用`{{target}}`代替，由安装器在安装时替换为安装目录。

下面是desktop文件示例：

```
[Desktop Entry]
Name=Kingdom Rush Frontiers - Tower Defense
Name[zh_CN]=王国保卫战:前线
Exec={{target}}/AppRun
Icon={{target}}/krf.png
Type=Application
Categories=Game;
```

# 踩坑记录

1. 脚本和压缩包合并的时候，脚本最后需要有一个空行，当时没注意，浪费挺长时间。
2. 原来计划通过静态编译Qt的方式，解决没有Qt的环境下运行图形化安装器的问题，但是折腾了好几天，发现坑巨多，因此最终选择了使用appimage打包的方式。